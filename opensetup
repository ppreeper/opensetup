#!/usr/bin/env bash
# This script was generated by bashly 1.1.10 (https://bashly.dannyb.co)
# Modifying it manually is not recommended

# :wrapper.bash3_bouncer
if [[ "${BASH_VERSINFO:-0}" -lt 4 ]]; then
	printf "bash version 4 or higher is required\n" >&2
	exit 1
fi

# :command.master_script

# :command.version_command
version_command() {
	echo "$version"
}

# :command.usage
opensetup_usage() {
	if [[ -n $long_usage ]]; then
		printf "opensetup - Ansible setup script\n"
		echo

	else
		printf "opensetup - Ansible setup script\n"
		echo

	fi

	printf "%s\n" "Usage:"
	printf "  opensetup COMMAND\n"
	printf "  opensetup [COMMAND] --help | -h\n"
	printf "  opensetup --version | -v\n"
	echo
	# :command.usage_commands
	printf "%s\n" "Commands:"
	printf "  %s   install necessary requirements\n" "setup "
	printf "  %s   deploy ansible playbook onto guest or group\n" "play  "
	printf "  %s   deploy ansible role onto guest or group\n" "role  "
	printf "  %s   check the syntax of a playbook\n" "syntax"
	printf "  %s   ping the host or group (default all)\n" "ping  "
	echo

	# :command.long_usage
	if [[ -n $long_usage ]]; then
		printf "%s\n" "Options:"

		# :command.usage_fixed_flags
		printf "  %s\n" "--help, -h"
		printf "    Show this help\n"
		echo
		printf "  %s\n" "--version, -v"
		printf "    Show version number\n"
		echo

		# :command.usage_environment_variables
		printf "%s\n" "Environment Variables:"

		# :environment_variable.usage
		printf "  %s\n" "PLAYBOOK_DIR"
		printf "\n"
		printf "    Default: ./playbooks\n"
		echo

	fi
}

# :command.usage
opensetup_setup_usage() {
	if [[ -n $long_usage ]]; then
		printf "opensetup setup - install necessary requirements\n"
		echo

	else
		printf "opensetup setup - install necessary requirements\n"
		echo

	fi

	printf "%s\n" "Usage:"
	printf "  opensetup setup\n"
	printf "  opensetup setup --help | -h\n"
	echo

	# :command.long_usage
	if [[ -n $long_usage ]]; then
		printf "%s\n" "Options:"

		# :command.usage_fixed_flags
		printf "  %s\n" "--help, -h"
		printf "    Show this help\n"
		echo

	fi
}

# :command.usage
opensetup_play_usage() {
	if [[ -n $long_usage ]]; then
		printf "opensetup play - deploy ansible playbook onto guest or group\n"
		echo

	else
		printf "opensetup play - deploy ansible playbook onto guest or group\n"
		echo

	fi

	printf "%s\n" "Usage:"
	printf "  opensetup play PLAYBOOK [TARGET]\n"
	printf "  opensetup play --help | -h\n"
	echo

	# :command.long_usage
	if [[ -n $long_usage ]]; then
		printf "%s\n" "Options:"

		# :command.usage_fixed_flags
		printf "  %s\n" "--help, -h"
		printf "    Show this help\n"
		echo

		# :command.usage_args
		printf "%s\n" "Arguments:"

		# :argument.usage
		printf "  %s\n" "PLAYBOOK"
		printf "    playbook to run\n"
		echo

		# :argument.usage
		printf "  %s\n" "TARGET"
		printf "    group or guest to target\n"
		printf "    Default: localhost\n"
		echo

	fi
}

# :command.usage
opensetup_role_usage() {
	if [[ -n $long_usage ]]; then
		printf "opensetup role - deploy ansible role onto guest or group\n"
		echo

	else
		printf "opensetup role - deploy ansible role onto guest or group\n"
		echo

	fi

	printf "%s\n" "Usage:"
	printf "  opensetup role ROLE [TARGET]\n"
	printf "  opensetup role --help | -h\n"
	echo

	# :command.long_usage
	if [[ -n $long_usage ]]; then
		printf "%s\n" "Options:"

		# :command.usage_fixed_flags
		printf "  %s\n" "--help, -h"
		printf "    Show this help\n"
		echo

		# :command.usage_args
		printf "%s\n" "Arguments:"

		# :argument.usage
		printf "  %s\n" "ROLE"
		printf "    role to run\n"
		echo

		# :argument.usage
		printf "  %s\n" "TARGET"
		printf "    group or guest to target\n"
		printf "    Default: localhost\n"
		echo

	fi
}

# :command.usage
opensetup_syntax_usage() {
	if [[ -n $long_usage ]]; then
		printf "opensetup syntax - check the syntax of a playbook\n"
		echo

	else
		printf "opensetup syntax - check the syntax of a playbook\n"
		echo

	fi

	printf "%s\n" "Usage:"
	printf "  opensetup syntax PLAYBOOK\n"
	printf "  opensetup syntax --help | -h\n"
	echo

	# :command.long_usage
	if [[ -n $long_usage ]]; then
		printf "%s\n" "Options:"

		# :command.usage_fixed_flags
		printf "  %s\n" "--help, -h"
		printf "    Show this help\n"
		echo

		# :command.usage_args
		printf "%s\n" "Arguments:"

		# :argument.usage
		printf "  %s\n" "PLAYBOOK"
		printf "    playbook to check\n"
		echo

	fi
}

# :command.usage
opensetup_ping_usage() {
	if [[ -n $long_usage ]]; then
		printf "opensetup ping - ping the host or group (default all)\n"
		echo

	else
		printf "opensetup ping - ping the host or group (default all)\n"
		echo

	fi

	printf "%s\n" "Usage:"
	printf "  opensetup ping [TARGET]\n"
	printf "  opensetup ping --help | -h\n"
	echo

	# :command.long_usage
	if [[ -n $long_usage ]]; then
		printf "%s\n" "Options:"

		# :command.usage_fixed_flags
		printf "  %s\n" "--help, -h"
		printf "    Show this help\n"
		echo

		# :command.usage_args
		printf "%s\n" "Arguments:"

		# :argument.usage
		printf "  %s\n" "TARGET"
		printf "    group or guest to target\n"
		echo

	fi
}

# :command.normalize_input
# :command.normalize_input_function
normalize_input() {
	local arg flags passthru
	passthru=false

	while [[ $# -gt 0 ]]; do
		arg="$1"
		if [[ $passthru == true ]]; then
			input+=("$arg")
		elif [[ $arg =~ ^(--[a-zA-Z0-9_\-]+)=(.+)$ ]]; then
			input+=("${BASH_REMATCH[1]}")
			input+=("${BASH_REMATCH[2]}")
		elif [[ $arg =~ ^(-[a-zA-Z0-9])=(.+)$ ]]; then
			input+=("${BASH_REMATCH[1]}")
			input+=("${BASH_REMATCH[2]}")
		elif [[ $arg =~ ^-([a-zA-Z0-9][a-zA-Z0-9]+)$ ]]; then
			flags="${BASH_REMATCH[1]}"
			for ((i = 0; i < ${#flags}; i++)); do
				input+=("-${flags:i:1}")
			done
		elif [[ "$arg" == "--" ]]; then
			passthru=true
			input+=("$arg")
		else
			input+=("$arg")
		fi

		shift
	done
}

# :command.inspect_args
inspect_args() {
	if ((${#args[@]})); then
		readarray -t sorted_keys < <(printf '%s\n' "${!args[@]}" | sort)
		echo args:
		for k in "${sorted_keys[@]}"; do
			echo "- \${args[$k]} = ${args[$k]}"
		done
	else
		echo args: none
	fi

	if ((${#other_args[@]})); then
		echo
		echo other_args:
		echo "- \${other_args[*]} = ${other_args[*]}"
		for i in "${!other_args[@]}"; do
			echo "- \${other_args[$i]} = ${other_args[$i]}"
		done
	fi

	if ((${#deps[@]})); then
		readarray -t sorted_keys < <(printf '%s\n' "${!deps[@]}" | sort)
		echo
		echo deps:
		for k in "${sorted_keys[@]}"; do
			echo "- \${deps[$k]} = ${deps[$k]}"
		done
	fi

	if ((${#env_var_names[@]})); then
		readarray -t sorted_names < <(printf '%s\n' "${env_var_names[@]}" | sort)
		echo
		echo "environment variables:"
		for k in "${sorted_names[@]}"; do
			echo "- \$$k = ${!k:-}"
		done
	fi
}

# :command.command_functions
# :command.function
opensetup_setup_command() {
	# src/setup_command.sh
	# install prereqs
	sudo bash -c "apt update -y && apt install -y python3-full python3-venv pipenv direnv git"

	# enable direnv
	if grep -q "direnv hook bash" $HOME/.bashrc; then
		echo
	else
		echo 'eval "$(direnv hook bash)"' >> $HOME/.bashrc
	fi

	# clone repo
	git clone https://github.com/ppreeper/opensetup $HOME/opensetup

	# reload bash
	source $HOME/.bashrc

}

# :command.function
opensetup_play_command() {
	# src/play_command.sh
	[ "${args[target]}" = "localhost" ] && export BECOME="-K" || export BECOME=""
	echo ansible-playbook -l ${args[target]} -b ${PLAYBOOK_DIR}/${args[playbook]}.yml $BECOME
	ansible-playbook -l ${args[target]} -b ${PLAYBOOK_DIR}/${args[playbook]}.yml $BECOME
}

# :command.function
opensetup_role_command() {
	# src/role_command.sh
	[ "${args[target]}" = "localhost" ] && export BECOME="-K" || export BECOME=""
	echo ansible-playbook -l ${args[target]} -e role=${args[role]} -b ${PLAYBOOK_DIR}/apply_role.yml $BECOME
	ansible-playbook -l ${args[target]} -e role=${args[role]} -b ${PLAYBOOK_DIR}/apply_role.yml $BECOME

}

# :command.function
opensetup_syntax_command() {
	# src/syntax_command.sh
	ansible-playbook --syntax-check ${PLAYBOOK_DIR}/${args[playbook]}.yml
}

# :command.function
opensetup_ping_command() {
	# src/ping_command.sh
	if [ -z "${args[target]}" ]; then
		ansible all -m ping -v
	else
		ansible ${args[target]} -m ping -v
	fi
}

# :command.parse_requirements
parse_requirements() {
	# :command.fixed_flags_filter
	while [[ $# -gt 0 ]]; do
		case "${1:-}" in
			--version | -v)
				version_command
				exit
				;;

			--help | -h)
				long_usage=yes
				opensetup_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	# :command.environment_variables_filter
	# :command.environment_variables_default
	export PLAYBOOK_DIR="${PLAYBOOK_DIR:-./playbooks}"

	env_var_names+=("PLAYBOOK_DIR")

	# :command.command_filter
	action=${1:-}

	case $action in
		-*) ;;

		setup)
			action="setup"
			shift
			opensetup_setup_parse_requirements "$@"
			shift $#
			;;

		play)
			action="play"
			shift
			opensetup_play_parse_requirements "$@"
			shift $#
			;;

		role)
			action="role"
			shift
			opensetup_role_parse_requirements "$@"
			shift $#
			;;

		syntax)
			action="syntax"
			shift
			opensetup_syntax_parse_requirements "$@"
			shift $#
			;;

		ping)
			action="ping"
			shift
			opensetup_ping_parse_requirements "$@"
			shift $#
			;;

		# :command.command_fallback
		"")
			opensetup_usage >&2
			exit 1
			;;

		*)
			printf "invalid command: %s\n" "$action" >&2
			exit 1
			;;

	esac

	# :command.parse_requirements_while
	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)
				# :command.parse_requirements_case
				# :command.parse_requirements_case_simple
				printf "invalid argument: %s\n" "$key" >&2
				exit 1

				;;

		esac
	done

}

# :command.parse_requirements
opensetup_setup_parse_requirements() {
	# :command.fixed_flags_filter
	while [[ $# -gt 0 ]]; do
		case "${1:-}" in
			--help | -h)
				long_usage=yes
				opensetup_setup_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	# :command.command_filter
	action="setup"

	# :command.parse_requirements_while
	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)
				# :command.parse_requirements_case
				# :command.parse_requirements_case_simple
				printf "invalid argument: %s\n" "$key" >&2
				exit 1

				;;

		esac
	done

}

# :command.parse_requirements
opensetup_play_parse_requirements() {
	# :command.fixed_flags_filter
	while [[ $# -gt 0 ]]; do
		case "${1:-}" in
			--help | -h)
				long_usage=yes
				opensetup_play_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	# :command.command_filter
	action="play"

	# :command.parse_requirements_while
	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)
				# :command.parse_requirements_case
				# :command.parse_requirements_case_simple
				# :argument.case
				if [[ -z ${args['playbook']+x} ]]; then
					args['playbook']=$1
					shift
				# :argument.case
				elif [[ -z ${args['target']+x} ]]; then
					args['target']=$1
					shift
				else
					printf "invalid argument: %s\n" "$key" >&2
					exit 1
				fi

				;;

		esac
	done

	# :command.required_args_filter
	if [[ -z ${args['playbook']+x} ]]; then
		printf "missing required argument: PLAYBOOK\nusage: opensetup play PLAYBOOK [TARGET]\n" >&2
		exit 1
	fi

	# :command.default_assignments
	[[ -n ${args['target']:-} ]] || args['target']="localhost"

}

# :command.parse_requirements
opensetup_role_parse_requirements() {
	# :command.fixed_flags_filter
	while [[ $# -gt 0 ]]; do
		case "${1:-}" in
			--help | -h)
				long_usage=yes
				opensetup_role_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	# :command.command_filter
	action="role"

	# :command.parse_requirements_while
	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)
				# :command.parse_requirements_case
				# :command.parse_requirements_case_simple
				# :argument.case
				if [[ -z ${args['role']+x} ]]; then
					args['role']=$1
					shift
				# :argument.case
				elif [[ -z ${args['target']+x} ]]; then
					args['target']=$1
					shift
				else
					printf "invalid argument: %s\n" "$key" >&2
					exit 1
				fi

				;;

		esac
	done

	# :command.required_args_filter
	if [[ -z ${args['role']+x} ]]; then
		printf "missing required argument: ROLE\nusage: opensetup role ROLE [TARGET]\n" >&2
		exit 1
	fi

	# :command.default_assignments
	[[ -n ${args['target']:-} ]] || args['target']="localhost"

}

# :command.parse_requirements
opensetup_syntax_parse_requirements() {
	# :command.fixed_flags_filter
	while [[ $# -gt 0 ]]; do
		case "${1:-}" in
			--help | -h)
				long_usage=yes
				opensetup_syntax_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	# :command.command_filter
	action="syntax"

	# :command.parse_requirements_while
	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)
				# :command.parse_requirements_case
				# :command.parse_requirements_case_simple
				# :argument.case
				if [[ -z ${args['playbook']+x} ]]; then
					args['playbook']=$1
					shift
				else
					printf "invalid argument: %s\n" "$key" >&2
					exit 1
				fi

				;;

		esac
	done

	# :command.required_args_filter
	if [[ -z ${args['playbook']+x} ]]; then
		printf "missing required argument: PLAYBOOK\nusage: opensetup syntax PLAYBOOK\n" >&2
		exit 1
	fi

}

# :command.parse_requirements
opensetup_ping_parse_requirements() {
	# :command.fixed_flags_filter
	while [[ $# -gt 0 ]]; do
		case "${1:-}" in
			--help | -h)
				long_usage=yes
				opensetup_ping_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	# :command.command_filter
	action="ping"

	# :command.parse_requirements_while
	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)
				# :command.parse_requirements_case
				# :command.parse_requirements_case_simple
				# :argument.case
				if [[ -z ${args['target']+x} ]]; then
					args['target']=$1
					shift
				else
					printf "invalid argument: %s\n" "$key" >&2
					exit 1
				fi

				;;

		esac
	done

}

# :command.initialize
initialize() {
	version="0.1.0"
	long_usage=''
	set -e

	# :command.environment_variables_default
	export PLAYBOOK_DIR="${PLAYBOOK_DIR:-./playbooks}"

}

# :command.run
run() {
	declare -A args=()
	declare -A deps=()
	declare -a other_args=()
	declare -a env_var_names=()
	declare -a input=()
	normalize_input "$@"
	parse_requirements "${input[@]}"

	case "$action" in
		"setup") opensetup_setup_command ;;
		"play") opensetup_play_command ;;
		"role") opensetup_role_command ;;
		"syntax") opensetup_syntax_command ;;
		"ping") opensetup_ping_command ;;
	esac
}

initialize
run "$@"
